# ISS-021: Role Permission Updates - Grade Override & Billing Course View

**Created:** 2026-01-14
**Priority:** High
**Type:** feature
**Status:** ✅ COMPLETED
**Completed Date:** 2026-01-14
**Git Commits:** 70d5fda (Phase 1-2), f870e10 (Phase 3-5)

---

## Completion Summary

Successfully implemented grade override system and enrollment-admin role with full UI integration.

**Phase 1-2 (Commit 70d5fda):**
- Created enrollment entity extensions (gradeOverrideTypes, gradeOverrideApi, useGradeOverride hooks)
- Built GradeOverrideDialog component with validation and confirmation
- Built GradeOverrideHistory component for audit trail display
- Added canOverrideGrades permission flag to useFeatureAccess

**Phase 3-5 (Commit f870e10):**
- Integrated grade override into StudentList roster component
- Added dropdown menu with "Override Grade" action
- Added enrollment-admin role to staff management dropdowns
- Updated StaffRole type definition

**Implementation Highlights:**
- Grade override requires 10-1000 character reason with real-time validation
- Creates immutable audit log entries with full context
- Permission-gated UI (canOverrideGrades flag)
- Fetches full enrollment details on dialog open
- Displays current grade (percentage, letter, points, gradedBy)
- Confirmation dialog before submission
- Success toast with change summary

**Files Created:**
- src/entities/enrollment/api/gradeOverrideApi.ts
- src/entities/enrollment/model/gradeOverrideTypes.ts
- src/entities/enrollment/model/gradeOverrideKeys.ts
- src/entities/enrollment/hooks/useGradeOverride.ts
- src/features/grading/ui/GradeOverrideDialog.tsx
- src/features/grading/ui/GradeOverrideHistory.tsx

**Files Modified:**
- src/entities/enrollment/index.ts - Export new types/hooks
- src/entities/enrollment/hooks/index.ts - Export grade override hooks
- src/features/grading/ui/index.ts - Export new components
- src/shared/hooks/useFeatureAccess.ts - Add canOverrideGrades flag
- src/features/classes/ui/StudentList.tsx - Add override functionality
- src/entities/staff-management/model/types.ts - Add enrollment-admin to StaffRole
- src/pages/admin/departments/components/AddStaffDialog.tsx - Add enrollment-admin option
- src/pages/admin/departments/components/EditStaffRoleDialog.tsx - Add enrollment-admin option

**API Integration:**
- PUT /api/v2/enrollments/:enrollmentId/grades/override
- GET /api/v2/enrollments/:enrollmentId/grades/history
- Authorization: academic:grades:override access right required

**Billing Admin Course View:**
- No UI changes required - billing-admin automatically has access via API permissions
- Optional enhancements can be added later (view-only badges, disabled edit buttons)

---

## Summary

Update the role permission system to add two new capabilities:
1. **dept-admin** can override/edit student grades (with mandatory change log)
2. **billing-admin** can view courses (list and details) for revenue reporting

---

## Contract Status

| Contract | Status | File |
|----------|--------|------|
| Grade Override Endpoint | ✅ Added | `api/contracts/api/enrollments.contract.ts` |
| Grade History Endpoint | ✅ Added | `api/contracts/api/enrollments.contract.ts` |
| Staff Roles Update | ✅ Updated | `api/contracts/api/roles.contract.ts` |
| API Team Notified | ✅ Sent | `agent_coms/messages/2026-01-14_170000_ui_contract_update_ISS-021.md` |

**UI team can begin implementation immediately against these contracts.**

---

## Background

These updates were identified during the role-function matrix review. The changes align with:
- Separation of concerns (dept-admin handles grade disputes, not instructors)
- Practical needs (billing needs to correlate revenue data with course information)

**Reference Document:** [COURSE_ROLE_FUNCTION_MATRIX.md](../specs/COURSE_ROLE_FUNCTION_MATRIX.md)

---

## Requirements

### 1. Grade Override for dept-admin

**Capability:** `grade:override`

| Aspect | Requirement |
|--------|-------------|
| Who | dept-admin role only |
| What | Can modify/correct student grades after initial grading |
| Why | Handle grade disputes, correct errors, administrative adjustments |
| Audit | **MANDATORY** - All grade changes must be logged with: timestamp, previous value, new value, reason, admin ID |

**UI Requirements:**
- Grade override UI accessible from student roster or gradebook
- Modal/form requiring reason field (required)
- Display previous grade value for reference
- Confirmation step before saving

**Distinction from instructor grading:**
- `instructor` grades during normal course flow (initial grades)
- `dept-admin` overrides/corrects after the fact (requires justification)

### 2. Course View for billing-admin

**Capability:** `course:view` (full access, not `course:view:financial`)

| Aspect | Requirement |
|--------|-------------|
| Who | billing-admin role |
| What | Can view course list and course details pages |
| Why | Correlate revenue reports with course information |
| Limits | View ONLY - no edit, no content preview, no module access |

**UI Requirements:**
- `/staff/courses` route accessible to billing-admin
- `/staff/courses/:id` (view) accessible to billing-admin
- No access to: `/staff/courses/:id/edit`, `/staff/courses/:id/modules`, content preview

---

## API Contract Changes Required

### New Endpoint: Grade Override

```
PUT /api/v1/enrollments/:enrollmentId/grades/:gradeId/override
```

**Request:**
```json
{
  "newValue": 85.5,
  "reason": "Grade appeal approved by academic committee",
  "previousValue": 72.0
}
```

**Response:**
```json
{
  "success": true,
  "gradeId": "grade-123",
  "enrollmentId": "enroll-456",
  "previousValue": 72.0,
  "newValue": 85.5,
  "overrideBy": "user-789",
  "overrideAt": "2026-01-14T15:30:00Z",
  "reason": "Grade appeal approved by academic committee",
  "changeLogId": "log-abc"
}
```

**Required Capability:** `grade:override`

### Updated Capability: billing-admin

Change `course:view:financial` → `course:view` for billing-admin role.

This allows billing-admin to access:
- `GET /api/v1/courses` (list)
- `GET /api/v1/courses/:id` (details)

---

## Implementation Notes

### Grade Change Log Schema

```typescript
interface GradeChangeLog {
  id: string;
  gradeId: string;
  enrollmentId: string;
  courseId: string;
  learnerId: string;
  previousValue: number;
  newValue: number;
  changedBy: string;        // User ID of dept-admin
  changedAt: Date;
  reason: string;           // Required explanation
  changeType: 'override';   // Distinguishes from initial grade
}
```

### Additive Role Behavior

Remember: capabilities are **deduplicated** when combined. If a user has both `instructor` and `dept-admin`, they get:
- `grade` (from instructor) - initial grading
- `grade:override` (from dept-admin) - corrections

These are distinct capabilities, not duplicates.

---

## Acceptance Criteria

- [ ] dept-admin can access grade override UI
- [ ] Grade override requires reason field (non-empty)
- [ ] All grade overrides are logged to GradeChangeLog
- [ ] billing-admin can access `/staff/courses` route
- [ ] billing-admin can view course details
- [ ] billing-admin CANNOT access course edit, modules, or content preview
- [ ] API endpoint validates `grade:override` capability
- [ ] API endpoint validates `course:view` for billing-admin

---

## Dependencies

- API contract changes (see API team message)
- ROLE_CAPABILITIES update in permission system

---

## Related Documents

- [COURSE_ROLE_FUNCTION_MATRIX.md](../specs/COURSE_ROLE_FUNCTION_MATRIX.md)
- [CONTENT_ADMIN_FLOW_DESIGN.md](../specs/CONTENT_ADMIN_FLOW_DESIGN.md)

---

**Status:** Awaiting API contract confirmation, then implementation planning
