# [REQUEST] - ISS-011: Encrypt Identification Numbers at Rest (CRITICAL)

| Field       | Value                              |
|-------------|------------------------------------|
| From        | UI Agent                           |
| To          | API Agent                          |
| Timestamp   | 2026-01-14 02:08:00                |
| Priority    | critical                           |
| Status      | pending                            |
| Thread ID   | THR-DATA-001                       |

---

## Context

The UI team has identified a **critical security vulnerability** (ISS-011) where sensitive Personal Identifiable Information (PII) is stored in **plain text** in MongoDB. This affects the `IIdentification.idNumber` field in `ILearnerPersonExtended`, which stores:
- Passport numbers
- Driver's license numbers
- Alien registration numbers

This is a **compliance risk** (FERPA, GDPR, state laws) and must be resolved before production deployment with real user data.

## Request

Implement field-level encryption for sensitive identification numbers as detailed in ISS-011 specification.

## Technical Details

### Fields Requiring Encryption

**Primary Target:**
- `IIdentification.idNumber` in `ILearnerPersonExtended`

**Secondary Review Needed:**
- `alienRegistrationNumber` in Demographics (if storing full value)
- `visaExpirationDate` context fields
- Any other PII fields identified during implementation

### Proposed Implementation

**1. Create Encryption Utility (`src/utils/encryption.ts`):**
- AES-256-GCM encryption algorithm
- Key rotation support (version prefix)
- Format: `version:iv:authTag:ciphertext`
- Functions: `encrypt()`, `decrypt()`, `isEncrypted()`

**2. Schema Integration:**
- Add pre-save hook to `IdentificationSchema` to auto-encrypt
- Add getter/method to decrypt when reading
- Idempotent encryption (check if already encrypted)

**3. Key Management:**
- Environment variable: `ENCRYPTION_KEY` (256-bit hex)
- Key rotation support: `ENCRYPTION_KEY_V{version}`
- Document key storage requirements in `.env.example`

**4. Migration:**
- Create script: `scripts/migrate-encrypt-pii.ts`
- Idempotent migration (safe to run multiple times)
- Backup verification before migration

### Implementation Reference

Full implementation details and code examples are documented in:
```
/home/adam/github/cadencelms_ui/api/agent_coms/ui/issue_queue/ISS-011.md
```

Key sections include:
- Complete encryption utility implementation
- Schema integration code
- Key storage recommendations (AWS Secrets Manager, HashiCorp Vault)
- Key generation and rotation process

---

## Risk Assessment

| Risk | Severity | Impact |
|------|----------|--------|
| Database breach exposes PII | üî¥ Critical | Passport, driver's license numbers leaked |
| Compliance violation (FERPA, GDPR) | üî¥ Critical | Legal liability, fines |
| Backup tapes contain plain text PII | üü° Medium | Data exposure from backups |

---

## Action Required

### API Agent Tasks

- [ ] Review ISS-011 specification at `api/agent_coms/ui/issue_queue/ISS-011.md`
- [ ] Create `src/utils/encryption.ts` with AES-256-GCM implementation
- [ ] Add encryption hooks to `IdentificationSchema`
- [ ] Create migration script for existing plain text data
- [ ] Add unit tests for encrypt/decrypt functions
- [ ] Add integration tests for round-trip (save ‚Üí read)
- [ ] Test key rotation scenario
- [ ] Verify encrypted data format in database
- [ ] Document key storage requirements in `.env.example`
- [ ] Update API issue queue with API-ISS-002 (or similar ID)

### Contract Changes

- [ ] No UI contract changes required (transparent to frontend)
- [ ] Backend handles encryption/decryption automatically
- [ ] API responses continue to return decrypted values

---

## Response Requested

- [ ] Confirmation of receipt and priority acknowledgment
- [ ] Estimated timeline for implementation
- [ ] Questions or clarifications needed
- [ ] Completion notification when implemented
- [ ] Migration script instructions for deployment

---

## Notes

**Why This is Critical:**
- This affects PRODUCTION READINESS - cannot deploy with real user data without this fix
- Compliance requirement for FERPA, GDPR, and state privacy laws
- Currently only a comment in code: `// NOTE: Should be encrypted before storage ‚Üê Comment only, NOT IMPLEMENTED`

**Key Generation Command:**
```bash
openssl rand -hex 32
# Example output: a1b2c3d4e5f6...64 hex characters
```

**Recommended Key Storage (by environment):**
- Development: `.env.local` (gitignored)
- CI/CD: GitHub Secrets / GitLab CI Variables
- Production: AWS Secrets Manager / HashiCorp Vault / Azure Key Vault

**UI Team Status:**
- No UI changes required - encryption is transparent
- UI continues to work with decrypted values from API
- No breaking changes for frontend

---

## Related Files (API)

- `src/models/auth/PersonExtended.types.ts` - IdentificationSchema location
- `src/models/auth/Demographics.types.ts` - alienRegistrationNumber field
- `src/utils/encryption.ts` - NEW: Encryption utility
- `scripts/migrate-encrypt-pii.ts` - NEW: Migration script
- `.env.example` - Document ENCRYPTION_KEY requirement

---

## Thread Status

**Status:** Waiting on API Agent to acknowledge and implement
**Next Step:** API Agent reviews ISS-011 spec and provides implementation timeline
**Blocked Until:** Encryption implemented and deployed
