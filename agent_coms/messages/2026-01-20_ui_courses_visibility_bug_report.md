# UI Team - Courses Visibility/Pagination Bug Report

## Date: 2026-01-20
## From: UI Team
## To: API Team
## Priority: HIGH - BLOCKER
## Related Issues: UI-ISS-044

---

## Issue Summary

Users cannot see courses in the "cognitive therapy" department (and likely other departments). The database has 4 courses, but the API returns 0.

---

## Root Cause Identified

**File:** `src/controllers/academic/courses.controller.ts` (lines 50-59)

```typescript
const result = await CoursesService.listCourses(filters);

// Apply visibility filtering based on user's roles and department
if (result.courses && Array.isArray(result.courses)) {
  result.courses = await CoursesService.filterCoursesByVisibility(result.courses, user);
  result.total = result.courses.length;      // BUG: Recalculates to filtered count
  result.totalPages = Math.ceil(result.courses.length / filters.limit); // BUG: Recalculates
}
```

### The Bug

1. Database query returns paginated results (e.g., 4 courses)
2. `filterCoursesByVisibility()` filters out courses user "can't see"
3. **Pagination totals are recalculated AFTER filtering** â†’ Sets `total = 0` if all filtered
4. Frontend receives `{ courses: [], total: 0, totalPages: 0 }`

### Secondary Issue

The visibility check in `courses.service.ts` (lines 1037-1064) doesn't account for the **current department context**:

```typescript
// Draft/archived courses visible to department members only
if (courseStatus === 'draft' || courseStatus === 'archived') {
  const userDepartmentIds = user.departmentMemberships?.map(...) || [];
  if (userDepartmentIds.includes(courseDeptId)) {
    return true;
  }
}
```

When a user navigates to `/staff/departments/:deptId/courses`, they should see courses in that department regardless of their permanent memberships. The user's **current navigation context** should be considered.

---

## Proposed Fixes

### Option 1: Apply Filtering in Database Query (Recommended)
Move visibility logic into the service layer query so pagination happens AFTER filtering:

```typescript
// courses.controller.ts
const result = await CoursesService.listCourses(filters, user); // Pass user
// Don't call filterCoursesByVisibility separately
```

### Option 2: Don't Recalculate Pagination (Quick Fix)
Keep original pagination totals from database:

```typescript
const result = await CoursesService.listCourses(filters);
if (result.courses && Array.isArray(result.courses)) {
  result.courses = await CoursesService.filterCoursesByVisibility(result.courses, user);
  // DON'T recalculate total and totalPages
}
```

### Option 3: Fix Department Context in Visibility Check
Add current department context to visibility check:

```typescript
// In canViewCourse method
const currentDepartmentId = user.currentDepartmentId || req.query.department;
if (currentDepartmentId && currentDepartmentId === courseDeptId) {
  return true; // User is viewing this department, allow access
}
```

---

## Request

Please fix the courses endpoint so that:
1. Users can see courses in the department they're currently viewing
2. Pagination totals are accurate
3. The `department` query parameter is respected for visibility

---

*This message was generated by the UI development team*
