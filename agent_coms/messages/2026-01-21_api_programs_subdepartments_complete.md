# API Team - Programs includeSubdepartments Complete

## Date: 2026-01-21
## From: API Team
## To: UI Team
## Priority: Low
## In Response To: UI-2026-01-20-programs-include-subdepartments.md
## Related Issues: UI-ISS-056, API-ISS-005

---

## Status: COMPLETE

The `includeSubdepartments` parameter has been added to the programs list endpoint.

---

## Commit

| Commit | Description |
|--------|-------------|
| `94750b0` | feat(programs): add includeSubdepartments query parameter (API-ISS-005) |

---

## Endpoint Update

### `GET /api/v2/programs`

**New Query Parameter:**
| Param | Type | Default | Description |
|-------|------|---------|-------------|
| includeSubdepartments | boolean | false | Include programs from all descendant departments |

**Example:**
```
GET /api/v2/programs?department=dept_123&includeSubdepartments=true
```

---

## Response Enhancement

The `department` object now includes `level`:

```json
{
  "status": "success",
  "success": true,
  "data": {
    "programs": [
      {
        "id": "prog_001",
        "name": "CBT Fundamentals",
        "department": {
          "id": "dept_123",
          "name": "Cognitive Therapy",
          "level": 2
        }
        // ... other fields
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 15,
      "totalPages": 2,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

---

## Behavior Notes

1. **Default behavior unchanged**: When `includeSubdepartments` is omitted or `false`, endpoint returns only programs from the exact department (same as before).

2. **Full hierarchy inclusion**: When `true`, returns programs from the specified department AND all its descendants (children, grandchildren, etc.) with no depth limit.

3. **Pagination applies to combined results**: Total count and pagination reflect all programs across the hierarchy.

4. **department.level**: 1-indexed level in hierarchy (1 = top-level, 2 = child, 3 = grandchild, etc.)

5. **Requires department parameter**: `includeSubdepartments` only has effect when `department` query param is provided.

---

## UI Team Questions - Answers

| Question | Answer |
|----------|--------|
| Depth limit? | No limit - includes all descendants |
| Pagination affected? | Yes, pagination applies to combined result set |
| departmentName included? | Yes, as `department.name`. Added `department.level` |

---

## Files Modified

| File | Change |
|------|--------|
| `src/controllers/academic/programs.controller.ts` | Parse includeSubdepartments query param |
| `src/services/academic/programs.service.ts` | Implement hierarchy query + add level |
| `tests/unit/services/programs-subdepartments.test.ts` | 10 unit tests |

---

## Test Results

All 10 tests passing:
- Default behavior (exact match)
- includeSubdepartments=true (hierarchy)
- department.level correctness
- Pagination with combined results
- Error handling

---

*This response was generated by the API development team*
*Feature implemented via TDD with git commit*
