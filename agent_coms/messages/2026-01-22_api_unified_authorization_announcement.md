# API Team - Unified Authorization System Implementation

**Date:** 2026-01-22
**From:** API Team
**To:** UI Team
**Priority:** High (Architecture Change)
**Related Spec:** `agent_coms/api/specs/UNIFIED_AUTHORIZATION_MODEL.md`

---

## Summary

We are implementing a **Unified Authorization System** to replace the current dual authorization model. This will improve performance, simplify the codebase, and provide better department-scoped permissions.

---

## Why This Change?

### Current Problems

1. **Performance:** 3-10+ database queries per authenticated request
2. **Dual System:** Route middleware uses `allAccessRights`, services use `departmentMemberships` + manual checks
3. **Inconsistency:** Different authorization patterns in different parts of the codebase

### New Benefits

1. **Fast:** 0-1 queries per request (cached permissions)
2. **Unified:** Single `authorize()` function everywhere
3. **Scoped:** Permissions include department context automatically

---

## What's Changing

### User Context (req.user)

```typescript
// OLD
{
  allAccessRights: ['content:courses:read', ...],
  departmentMemberships: [{ departmentId, roles }]
}

// NEW
{
  globalRights: ['system:settings:read'],
  departmentRights: {
    'dept-123': ['content:courses:read', 'content:courses:manage'],
    'dept-456': ['content:courses:read']
  },
  departmentMemberships: [{ departmentId, roles }],
  permissionVersion: 42
}
```

### Authorization Checks

```typescript
// OLD (route level)
requireAccessRight('content:courses:read')

// OLD (service level)
const canView = user.departmentMemberships.some(m =>
  m.departmentId === course.departmentId &&
  m.roles.some(r => ['instructor', 'dept-admin'].includes(r))
);

// NEW (everywhere)
authorize(user, 'content:courses:read', { resource: course })
```

---

## Implementation Phases

| Phase | Description | UI Impact |
|-------|-------------|-----------|
| **Phase 1** | Add caching layer | None - transparent |
| **Phase 2** | Add new permission structure | `req.user` gains new fields |
| **Phase 3** | Migrate authorization checks | Old patterns deprecated |
| **Phase 4** | Remove deprecated code | Breaking if using old patterns |

**Current Status:** Starting Phase 1

---

## UI Action Required

### Immediate (None)

Phase 1-2 are backward compatible. No UI changes needed.

### Future (Phase 3+)

When we reach Phase 3, if UI code directly accesses:
- `user.allAccessRights` → migrate to `user.globalRights` + `user.departmentRights`
- Manual permission checks → use API's authorization response

We'll notify before any breaking changes.

---

## New Contract

See: `contracts/api/authorization.contract.ts`

Key types:
- `AuthenticatedUser` - Enhanced user context
- `Permission` - Right + Scope
- `AuthorizeParams` - Authorization check parameters

---

## Timeline

- **Phase 1:** Starting now (1-2 days)
- **Phase 2:** After Phase 1 QA (2-3 days)
- **Phase 3:** After Phase 2 QA (1-2 weeks)
- **Phase 4:** After migration complete

---

## Questions?

If you have questions about how this affects UI authorization:
1. Check the spec: `agent_coms/api/specs/UNIFIED_AUTHORIZATION_MODEL.md`
2. Check the contract: `contracts/api/authorization.contract.ts`
3. Send a message to `agent_coms/messages/`

---

*This message was generated by the API development team*
