# API Response: Course Permission Fix Complete (Final)

**Date:** 2026-01-22
**From:** API Team
**To:** UI Team
**Priority:** High
**Issue:** API-ISS-062
**Status:** FIXED

---

## Root Cause

The `isAuthenticated` middleware was fetching Staff/Learner records to build `allAccessRights`, but was discarding the `departmentMemberships` data. The `canViewCourse` function needed department memberships for its department-based access checks.

---

## Fix Applied (Two Parts)

### 1. Updated `isAuthenticated` middleware

**File:** `src/middlewares/isAuthenticated.ts`

- Added `DepartmentMembership` interface
- Added `departmentMemberships` to `AuthenticatedUser` interface
- Renamed `getUserAccessRights()` to `getUserAuthorizationInfo()`
- Now returns both `accessRights` and `departmentMemberships`
- Populates `req.user.departmentMemberships` with user's department memberships and roles

```typescript
export interface DepartmentMembership {
  departmentId: string;
  roles: string[];
}

export interface AuthenticatedUser {
  // ... existing fields ...
  departmentMemberships: DepartmentMembership[];  // NEW
}
```

### 2. Updated `canViewCourse` in courses.service.ts

**File:** `src/services/academic/courses.service.ts`

- Uses `user.departmentMemberships` from `isAuthenticated` (no extra DB query)
- Falls back to fetching from Staff collection if not present
- Checks per-department roles (instructor, department-admin, content-admin)
- Supports hierarchical department access

---

## Authorization Pattern

```
Request Flow:
1. isAuthenticated middleware
   - Verifies JWT token
   - Fetches User from DB
   - Fetches Staff/Learner records
   - Builds allAccessRights[] from role definitions
   - Builds departmentMemberships[] with per-department roles
   - Attaches to req.user

2. requireAccessRight('content:courses:read')
   - Checks req.user.allAccessRights
   - Route-level authorization

3. Controller calls canViewCourse(course, req.user)
   - Uses req.user.departmentMemberships
   - Department-specific authorization for draft/archived courses
```

---

## Permission Rules

| User Type | Access |
|-----------|--------|
| System Admin / Global Admin | All courses |
| Course Creator | Own courses (any status) |
| Department Staff (instructor/dept-admin/content-admin) | All courses in their department |
| Other Department Members | Published + Draft/Archived in their dept |
| General Users | Published courses only |

---

## Test Case

1. Login as `riley.instructor@lms.edu` / `Password123!`
2. Riley has:
   - `cognitive` department: `['instructor', 'content-admin', 'department-admin']`
   - `cbtFundamentals` department: `['instructor']`
3. Preview "Advanced Cognitive Interventions" (in `cognitive` department)
4. **Expected:** Can view (riley has `instructor` role in `cognitive` department)

---

*This message was generated by the API development team*
