# API Response: Course Permission Fix Complete (v3)

**Date:** 2026-01-22
**From:** API Team
**To:** UI Team
**Priority:** High
**Issue:** API-ISS-062
**Status:** FIXED

---

## Root Cause Found

The JWT access token only contains `userId`, `email`, and `roles`. It does **NOT** include `departmentMemberships`.

The `canViewCourse()` function was trying to read `user.departmentMemberships` from the request user object, but this field is never populated from the JWT token.

**File:** `src/utils/jwt.ts:24-39`
```typescript
export function generateAccessToken(userId, email, roles) {
  // Only userId, email, roles - NO departmentMemberships!
  const payload = { userId, email, roles, type: 'access' };
  return jwt.sign(payload, ...);
}
```

---

## Fix Applied

Updated `canViewCourse()` to fetch department memberships from the database when not available on the user object:

```typescript
// Get user's department memberships - fetch from DB since JWT doesn't include them
let userDepartmentIds: string[] = [];
let userDepartmentRoles: Map<string, string[]> = new Map();

// Try to get from user object first (if populated)
if (user.departmentMemberships && user.departmentMemberships.length > 0) {
  // Use existing data
} else if (userId) {
  // Fetch from database - JWT doesn't include department memberships
  const staffRecord = await Staff.findOne({ userId: userId }).lean();
  if (staffRecord && staffRecord.departmentMemberships) {
    // Extract department IDs and roles from staff record
  }
}
```

Also added `hasStaffRoleInCourseDepartment()` helper that checks both:
1. Direct department membership with staff role
2. Hierarchical membership (parent department staff can see subdepartment courses)

---

## What Changed

| Before | After |
|--------|-------|
| Read `departmentMemberships` from user object (always empty) | Fetch from Staff collection if not on user object |
| Check global `user.roles` for staff roles | Check per-department roles from staff memberships |
| Single department check | Hierarchical department check with role verification |

---

## Test Case

1. Login as `riley.instructor@lms.edu` / `Password123!`
2. Riley's staff record has:
   - `cognitive` department: roles `['instructor', 'content-admin', 'department-admin']`
   - `cbtFundamentals` department: roles `['instructor']`
3. Try to preview "Advanced Cognitive Interventions" (in `cognitive` department)
4. **Expected:** Can view (riley has `instructor` role in `cognitive` department)

---

## Notes

- This is a database query per `canViewCourse` call, but it's necessary since JWT doesn't contain memberships
- Consider adding `departmentMemberships` to JWT in future (would require token refresh logic)
- The Staff record is fetched with `.lean()` for performance

---

*This message was generated by the API development team*
