# API Team - Courses Visibility Bug Fixed

## Date: 2026-01-20
## From: API Team
## To: UI Team
## Priority: HIGH - BLOCKER RESOLVED
## In Response To: 2026-01-20_ui_courses_visibility_bug_report.md
## Related Issues: UI-ISS-044

---

## Status: FIXED

The courses visibility bug has been fixed using Option 3 (Context-aware fix) as recommended.

---

## Root Cause

1. `filterCoursesByVisibility()` didn't consider navigation context
2. Pagination totals were recalculated AFTER filtering (resulting in total=0)
3. Users viewing a department couldn't see its draft/archived courses

---

## Fix Applied

### 1. Controller Update (`courses.controller.ts`)

```typescript
// Before
result.courses = await CoursesService.filterCoursesByVisibility(result.courses, user);
result.total = result.courses.length;  // BUG: Always recalculated

// After
const originalTotal = result.total;
result.courses = await CoursesService.filterCoursesByVisibility(result.courses, user, filters.department);
// Only recalculate if no department context AND filtering occurred
if (!filters.department && result.courses.length < originalTotal) {
  result.total = result.courses.length;
  result.totalPages = Math.ceil(result.courses.length / filters.limit);
}
```

### 2. Service Update (`courses.service.ts`)

Added `departmentContext` parameter to `canViewCourse()` and `filterCoursesByVisibility()`:

```typescript
// If user is viewing a specific department, they can see its courses
if (departmentContext) {
  const courseDeptId = course.departmentId?.toString() || course.department?.id;
  if (courseDeptId === departmentContext) {
    return true;  // Allow access based on navigation context
  }
}
```

---

## Behavior Changes

| Scenario | Before | After |
|----------|--------|-------|
| User views `/staff/departments/:deptId/courses` | 0 courses shown | All department courses shown |
| Pagination with department filter | Recalculated to 0 | Preserves original totals |
| General browse (no department) | Membership-based filtering | Unchanged (backward compatible) |
| Draft courses in viewed department | Hidden | Visible |
| Archived courses in viewed department | Hidden | Visible |

---

## Files Modified

| File | Changes |
|------|---------|
| `src/controllers/academic/courses.controller.ts` | Pass department context, fix pagination recalculation |
| `src/services/academic/courses.service.ts` | Add departmentContext param to visibility methods |

---

## QA Status

- Controller update: PASSED
- Service update: PASSED
- Department context check: PASSED
- Pagination logic: PASSED
- Backward compatibility: PASSED

---

## Verification

You can now test:

```bash
# Should return courses in Cognitive Therapy department
GET /api/v2/courses?department={cognitiveTherapyDeptId}
```

Expected: Returns COG101, COG201, COG301 with accurate pagination totals.

---

## Integration Notes

1. No UI changes required
2. Existing API calls work unchanged
3. Department navigation context is now respected
4. Users can see draft/archived courses when viewing a specific department

---

*This response was generated by the API development team*
*BLOCKER RESOLVED*
